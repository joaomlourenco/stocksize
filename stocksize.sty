%% This is file `stocksize.sty'
%%
%% Copyright (C) 2024–25 by João M. Lourenço <joao.lourenco@fct.unl.pt>
%%
%% This file may be distributed and/or modified under the conditions of
%% the LaTeX Project Public License, either version 1.3c of this license
%% or (at your option) any later version. The latest version of this
%% license is in:
%%
%%    http://www.latex-project.org/lppl.txt
%%
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2025/12/13 or later.
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage{stocksize}
                    {2025/01/01}
                    {2.0.0}
                    {Synchronize physical with logical paper size (Stack Aware)}


\RequirePackage{geometry}
\RequirePackage{l3keys2e}

% Redefine \newgeometry and \restoregeometry from geometry.sty 
% so that these commands work in a stack (nested) mode

% 1. Initialize the stack counter
\newcount\Gm@stackcnt
\Gm@stackcnt=\z@

% 2. Redefine \newgeometry to PUSH to stack
\renewcommand{\newgeometry}[1]{%
  \clearpage
  % --- Stack Push Logic ---
  % Initialize \Gm@restore locally so we don't append to previous junk
  \def\Gm@restore{}%
  % Call \Gm@save. This builds the \Gm@restore macro with "fetch instructions"
  \Gm@save
  % Increment stack counter
  \global\advance\Gm@stackcnt\@ne
  % Use \xdef to EXPAND \Gm@restore now.
  % This converts "\the\paperwidth" into "597pt" and stores the result.
  \global\expandafter\xdef\csname Gm@stack@\the\Gm@stackcnt\endcsname{\Gm@restore}%
  % ------------------------
  \Gm@restore@org                 % Reset to preamble defaults
  \Gm@initnewgm
  \Gm@newgmtrue
  \setkeys{Gm}{#1}%
  \Gm@newgmfalse
  \Gm@process
  \ifnum\mag=\@m\else\Gm@magtooffset\fi
  \Gm@changelayout
  \Gm@showparams{newgeometry}}

% 3. Redefine \restoregeometry to POP from stack
\renewcommand{\restoregeometry}{%
  \clearpage
  % --- Stack Pop Logic ---
  \ifnum\Gm@stackcnt>\z@
    % Stack is not empty: Execute the macro for the current level
    \csname Gm@stack@\the\Gm@stackcnt\endcsname
    % Decrement the counter
    \global\advance\Gm@stackcnt\m@ne
  \else
    % Stack is empty: Fallback to original behavior
    \Gm@restore@pkg
  \fi
  % -----------------------
  \Gm@changelayout}



% ----------------------------------------------------------------------------
% 1. Variables
% ----------------------------------------------------------------------------
\clist_new:N \l__geostack_options_clist
\clist_new:N \l__geostack_defaults_clist
\bool_new:N  \l__geostack_patch_bool

% ----------------------------------------------------------------------------
% 2. Helper: Synchronize Physical Paper Size
% ----------------------------------------------------------------------------
\cs_new_protected:Nn \__geostack_sync_physical_size:
  {
    \setlength{\paperwidth}{\the\Gm@layoutwidth}
    \setlength{\paperheight}{\the\Gm@layoutheight}
    
    % Sync PDF driver dimensions
    \cs_if_exist:NT \pdfpagewidth
      {
        \setlength{\pdfpagewidth}{\paperwidth}
        \setlength{\pdfpageheight}{\paperheight}
      }
    \cs_if_exist:NT \pagewidth
      {
        \setlength{\pagewidth}{\paperwidth}
        \setlength{\pageheight}{\paperheight}
      }
    \cs_if_exist:NT \stockwidth
      {
        \setlength{\stockwidth}{\paperwidth}
        \setlength{\stockheight}{\paperheight}
      }
      
    % Inform geometry of layout changes (internal recalculations)
    \cs_if_exist:cT { Gm@changelayout }
      {
        \use:c { Gm@changelayout }
      }
  }

% ----------------------------------------------------------------------------
% 3. Main Environment: newstocksize
% ----------------------------------------------------------------------------
\NewDocumentCommand {\newstocksize } { m }
  {
    % --- STEP 1: Process 'keepmargins' ---
    \clist_set:Nn \l__geostack_options_clist { #1 }
    \clist_clear:N \l__geostack_defaults_clist
    
    \clist_if_in:NnTF \l__geostack_options_clist { keepmargins }
      {
        % Capture the CURRENT margins before \newgeometry wipes them.
        % We expand the internal geometry macros to get the current values.
        \clist_put_right:Nx \l__geostack_defaults_clist { lmargin = \use:c{Gm@lmargin} }
        \clist_put_right:Nx \l__geostack_defaults_clist { rmargin = \use:c{Gm@rmargin} }
        \clist_put_right:Nx \l__geostack_defaults_clist { tmargin = \use:c{Gm@tmargin} }
        \clist_put_right:Nx \l__geostack_defaults_clist { bmargin = \use:c{Gm@bmargin} }
        
        % Remove 'keepmargins' from the list passed to \newgeometry
        \clist_remove_all:Nn \l__geostack_options_clist { keepmargins }
      }
      { }
      
    % Merge the calculated defaults with the user's explicit options
    \clist_put_right:NV \l__geostack_defaults_clist \l__geostack_options_clist
    
    % --- STEP 2: Change Geometry ---
    % \newgeometry (patched) will automatically push the OLD state to the stack.
    \exp_args:NV \newgeometry \l__geostack_defaults_clist
    
    % --- STEP 3: Sync Physical Size ---
    \__geostack_sync_physical_size:
  }

\NewDocumentCommand {\restorestocksize } {}
  {
    % --- STEP 4: Restore Geometry ---
    % \restoregeometry (patched) will automatically pop the state from the stack.
    \restoregeometry
    
    % --- STEP 5: Sync Physical Size (Restored) ---
    \__geostack_sync_physical_size:
  }

% ----------------------------------------------------------------------------
% 4. Package Options
% ----------------------------------------------------------------------------

\keys_define:nn { stocksize }
  {
    patch-geometry .bool_set:N = \l__geostack_patch_bool,
    patch-geometry .default:n = true,
  }

\ProcessKeysPackageOptions { stocksize }

% If requested, patch standard commands to always sync physical size
\bool_if:NT \l__geostack_patch_bool
  {
    \apptocmd{\newgeometry}
      {\__geostack_sync_physical_size:}
      {}{\PackageWarning{stocksize}{Failed to patch newgeometry}}
      
    \apptocmd{\restoregeometry}
      {\__geostack_sync_physical_size:}
      {}{\PackageWarning{stocksize}{Failed to patch restoregeometry}}
      
    \apptocmd{\loadgeometry}
      {\__geostack_sync_physical_size:}
      {}{\PackageWarning{stocksize}{Failed to patch loadgeometry}}
  }

\endinput